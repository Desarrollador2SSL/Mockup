<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nueva Orden de Compra - SSL v4.0</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Archivo CSS del menú separado -->
    <link rel="stylesheet" href="../css/menu-styles.css">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #667eea;
            --accent-color: #764ba2;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --error-color: #e74c3c;
            --info-color: #17a2b8;
            --text-color: #333;
            --text-light: #ecf0f1;
            --border-color: #ddd;
            --hover-color: #5a52d5;
            --active-color: #4a42b5;
            --menu-width: 260px;
            --menu-collapsed-width: 70px;
            --header-height: 65px;
            --transition-speed: 0.3s;
            --card-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            --hover-shadow: 0 5px 20px rgba(0, 0, 0, 0.12);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f8f9fa;
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Header */
        .header {
            background-color: white;
            color: var(--text-color);
            height: var(--header-height);
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo img {
            height: 40px;
        }

        .logo-text {
            display: flex;
            flex-direction: column;
        }

        .logo h1 {
            font-size: 1.4rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        .portal-type {
            font-size: 0.8rem;
            color: var(--secondary-color);
            font-weight: 500;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-date {
            display: flex;
            align-items: center;
            font-size: 0.9rem;
            color: #666;
            padding: 0 15px;
            border-right: 1px solid var(--border-color);
            height: 35px;
        }

        .header-date i {
            margin-right: 8px;
            color: var(--secondary-color);
        }

        .notifications {
            position: relative;
            margin-right: 15px;
        }

        .notifications-button {
            background: none;
            border: none;
            font-size: 1.2rem;
            color: #666;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all var(--transition-speed);
        }

        .notifications-button:hover {
            background-color: #f0f0f0;
            color: var(--secondary-color);
        }

        .notification-count {
            position: absolute;
            top: 0;
            right: 0;
            background-color: var(--error-color);
            color: white;
            border-radius: 50%;
            font-size: 0.7rem;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .user-menu {
            display: flex;
            align-items: center;
            margin-left: 10px;
            cursor: pointer;
            position: relative;
            padding: 8px 12px;
            border-radius: 8px;
            transition: background-color var(--transition-speed);
        }

        .user-menu:hover {
            background-color: #f0f0f0;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--secondary-color), var(--accent-color));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            margin-right: 10px;
            font-weight: 600;
        }

        .user-name {
            font-weight: 500;
            margin-right: 8px;
            color: var(--text-color);
        }

        .user-menu-arrow {
            font-size: 0.8rem;
            color: #666;
            transition: transform var(--transition-speed);
        }

        .user-menu.active .user-menu-arrow {
            transform: rotate(180deg);
        }

        /* User Dropdown */
        .user-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 10px;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.15);
            min-width: 220px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all var(--transition-speed);
        }

        .user-menu.active .user-dropdown {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            background-color: #f8f9fa;
            border-radius: 12px 12px 0 0;
        }

        .dropdown-user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .dropdown-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--secondary-color), var(--accent-color));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .dropdown-user-details {
            flex: 1;
        }

        .dropdown-user-name {
            font-weight: 600;
            color: var(--text-color);
            font-size: 0.95rem;
        }

        .dropdown-user-email {
            font-size: 0.85rem;
            color: #666;
        }

        .dropdown-menu {
            padding: 8px 0;
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: var(--text-color);
            text-decoration: none;
            transition: background-color var(--transition-speed);
            cursor: pointer;
        }

        .dropdown-item:hover {
            background-color: #f8f9fa;
        }

        .dropdown-item i {
            margin-right: 12px;
            width: 20px;
            text-align: center;
            color: #666;
        }

        .dropdown-divider {
            height: 1px;
            background-color: var(--border-color);
            margin: 8px 0;
        }

        .dropdown-item.logout {
            color: var(--error-color);
        }

        .dropdown-item.logout i {
            color: var(--error-color);
        }

        /* Container */
        .container {
            display: flex;
            flex: 1;
            margin-top: var(--header-height);
        }

        /* Content */
        .content {
            flex: 1;
            padding: 30px;
            margin-left: var(--menu-width);
            transition: margin-left var(--transition-speed);
        }

        .sidebar.collapsed ~ .content {
            margin-left: var(--menu-collapsed-width);
        }

        .breadcrumb {
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            font-size: 0.9rem;
        }

        .breadcrumb-item {
            display: inline-block;
            color: #666;
        }

        .breadcrumb-item:not(:last-child)::after {
            content: "/";
            margin: 0 10px;
            color: #ccc;
        }

        .breadcrumb-item a {
            color: var(--secondary-color);
            text-decoration: none;
            transition: color var(--transition-speed);
        }

        .breadcrumb-item a:hover {
            color: var(--accent-color);
            text-decoration: underline;
        }

        .breadcrumb-item.active {
            color: var(--text-color);
            font-weight: 500;
        }

        /* Page Header */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .page-title {
            font-size: 2rem;
            color: var(--primary-color);
            font-weight: 600;
        }

        /* Steps Indicator */
        .steps-container {
            background-color: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: var(--card-shadow);
        }

        .steps {
            display: flex;
            justify-content: space-between;
            position: relative;
        }

        .step {
            flex: 1;
            text-align: center;
            position: relative;
        }

        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #e9ecef;
            color: #999;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            font-weight: 600;
            position: relative;
            z-index: 2;
            transition: all var(--transition-speed);
        }

        .step.active .step-number {
            background: linear-gradient(135deg, var(--secondary-color), var(--accent-color));
            color: white;
        }

        .step.completed .step-number {
            background-color: var(--success-color);
            color: white;
        }

        .step-title {
            font-size: 0.9rem;
            color: #999;
            transition: color var(--transition-speed);
        }

        .step.active .step-title {
            color: var(--primary-color);
            font-weight: 500;
        }

        .step.completed .step-title {
            color: var(--success-color);
        }

        .step-line {
            position: absolute;
            top: 20px;
            left: 50%;
            width: 100%;
            height: 2px;
            background-color: #e9ecef;
            z-index: 1;
        }

        .step:last-child .step-line {
            display: none;
        }

        .step.completed .step-line {
            background-color: var(--success-color);
        }

        /* Form Sections */
        .form-section {
            background-color: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: var(--card-shadow);
        }

        .section-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .section-title i {
            margin-right: 10px;
            color: var(--secondary-color);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .form-grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 8px;
            font-weight: 500;
            color: #666;
            font-size: 0.9rem;
        }

        .form-group label span.required {
            color: var(--error-color);
        }

        .form-control {
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 0.95rem;
            transition: all var(--transition-speed);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-control[readonly] {
            background-color: #f8f9fa;
            cursor: not-allowed;
        }

        textarea.form-control {
            resize: vertical;
            min-height: 100px;
        }

        .form-help {
            font-size: 0.85rem;
            color: #999;
            margin-top: 5px;
        }

        /* Info Section */
        .info-section {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .info-section h3 {
            font-size: 1rem;
            color: var(--primary-color);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .info-section h3 i {
            margin-right: 8px;
            color: var(--secondary-color);
            font-size: 0.9rem;
        }

        .info-grid {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 10px 20px;
            font-size: 0.9rem;
        }

        .info-grid2 {
            display: grid;
            grid-template-columns: auto 3fr;
            gap: 10px 20px;
            font-size: 0.9rem;
        }

        .info-label {
            font-weight: 500;
            color: #666;
        }

        .info-value {
            color: var(--text-color);
        }

        .form-value {
            padding: 10px 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            font-size: 0.95rem;
            color: var(--text-color);
            min-height: 42px;
            display: flex;
            align-items: center;
        }

        /* Cotización Selection */
        .cotizacion-item {
            background-color: #f8f9fa;
            border: 2px solid transparent;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all var(--transition-speed);
        }

        .cotizacion-item:hover {
            border-color: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: var(--hover-shadow);
        }

        .cotizacion-item.selected {
            border-color: var(--secondary-color);
            background-color: #e8eafd;
        }

        .cotizacion-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .cotizacion-number {
            font-weight: 600;
            color: var(--primary-color);
            font-size: 1.1rem;
        }

        .cotizacion-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            color: #666;
            font-size: 0.9rem;
        }

        /* Products Table */
        .products-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 0.95rem;
        }

        .products-table th {
            background-color: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid var(--border-color);
            color: var(--primary-color);
        }

        .products-table td {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
        }

        .products-table tbody tr:hover {
            background-color: #f8f9fa;
        }

        .products-table input {
            width: 100%;
            padding: 6px 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .products-table input:focus {
            outline: none;
            border-color: var(--secondary-color);
        }

        .products-table tfoot {
            font-weight: 600;
        }

        .products-table tfoot td {
            padding: 15px 12px;
            border-top: 2px solid var(--border-color);
            background-color: #f8f9fa;
        }

        /* File Upload */
        .file-upload {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            transition: all var(--transition-speed);
            cursor: pointer;
            margin-top: 20px;
        }

        .file-upload:hover {
            border-color: var(--secondary-color);
            background-color: #f8f9fa;
        }

        .file-upload.dragover {
            border-color: var(--secondary-color);
            background-color: #e8eafd;
        }

        .file-upload i {
            font-size: 3rem;
            color: #ddd;
            margin-bottom: 15px;
        }

        .file-upload p {
            color: #666;
            margin-bottom: 10px;
        }

        .file-upload-button {
            padding: 8px 20px;
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color var(--transition-speed);
        }

        .file-upload-button:hover {
            background-color: var(--hover-color);
        }

        .uploaded-files {
            margin-top: 20px;
        }

        .uploaded-file {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 10px;
        }

        .uploaded-file-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .uploaded-file-info i {
            color: var(--secondary-color);
        }

        .remove-file {
            color: var(--error-color);
            cursor: pointer;
            padding: 5px;
        }

        .remove-file:hover {
            color: #c0392b;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-speed);
            display: inline-flex;
            align-items: center;
            text-decoration: none;
            font-size: 0.95rem;
        }

        .btn i {
            margin-right: 6px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--secondary-color), var(--accent-color));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color), #2ecc71);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3);
        }

        .btn-outline {
            background-color: white;
            color: var(--secondary-color);
            border: 1px solid var(--secondary-color);
        }

        .btn-outline:hover {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        /* Navigation buttons */
        .form-navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }

        /* Status Badge */
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        /* Help Button */
        .help-button-container {
            margin: 0 15px;
        }

        .help-button {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            background-color: var(--secondary-color);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all var(--transition-speed);
            position: relative;
        }

        .help-button:hover {
            background-color: var(--hover-color);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .help-button i {
            font-size: 1.1rem;
        }

        .help-text {
            display: inline-block;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .menu-toggle {
                display: block;
            }

            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .content {
                margin-left: 0 !important;
                padding: 20px;
            }

            .user-name {
                display: none;
            }

            .header-date {
                display: none;
            }

            .page-header {
                flex-direction: column;
                gap: 20px;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .form-grid-2 {
                grid-template-columns: 1fr;
            }

            .products-table {
                font-size: 0.8rem;
                overflow-x: auto;
                display: block;
            }

            .steps {
                font-size: 0.8rem;
            }

            .step-number {
                width: 30px;
                height: 30px;
                font-size: 0.9rem;
            }

            .info-grid {
                grid-template-columns: 1fr;
            }

            .help-text {
                display: none;
            }
            
            .help-button {
                padding: 8px 12px;
            }             
        }

        @media (max-width: 1024px) and (min-width: 769px) {
            .form-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-left">
            <div class="menu-toggle" onclick="toggleMobileMenu()">
                <i class="fas fa-bars"></i>
            </div>
            <div class="logo">
                <img src="../PagWebLocal/logo_ssl.png" alt="SSL Logo">
                <div class="logo-text">
                    <h1>SSL v4.0</h1>
                    <span class="portal-type">Portal Cliente</span>
                </div>
            </div>
        </div>
        
        <div class="header-right">
            <div class="header-date">
                <i class="fas fa-calendar-alt"></i>
                <span id="currentDate">Cargando...</span>
            </div>

            <!-- AGREGAR ESTE BOTÓN DE AYUDA -->
            <div class="help-button-container">
                <a href="../cliente_navegacion.html" class="help-button" title="Ayuda y Navegación">
                    <i class="fas fa-question-circle"></i>
                    <span class="help-text">Ayuda</span>
                </a>
            </div>
                        
            <div class="notifications">
                <button class="notifications-button" onclick="showNotifications()">
                    <i class="fas fa-bell"></i>
                </button>
                <span class="notification-count">5</span>
            </div>
            
            <div class="user-menu" id="userMenu">
                <div class="user-avatar">
                    <span id="userInitial">C</span>
                </div>
                <span class="user-name" id="userName">Empresa Demo S.A.</span>
                <i class="fas fa-chevron-down user-menu-arrow"></i>
                
                <div class="user-dropdown">
                    <div class="dropdown-header">
                        <div class="dropdown-user-info">
                            <div class="dropdown-avatar">
                                <span id="dropdownUserInitial">C</span>
                            </div>
                            <div class="dropdown-user-details">
                                <div class="dropdown-user-name" id="dropdownUserName">Empresa Demo S.A.</div>
                                <div class="dropdown-user-email" id="dropdownUserEmail">cliente@demo.com</div>
                            </div>
                        </div>
                    </div>
                    <div class="dropdown-menu">
                        <a href="#" class="dropdown-item" onclick="goToProfile(event)">
                            <i class="fas fa-user-circle"></i>
                            <span>Mi Perfil</span>
                        </a>
                        <a href="#" class="dropdown-item" onclick="goToSettings(event)">
                            <i class="fas fa-cog"></i>
                            <span>Configuración</span>
                        </a>
                        <div class="dropdown-divider"></div>
                        <a href="#" class="dropdown-item logout" onclick="logout(event)">
                            <i class="fas fa-sign-out-alt"></i>
                            <span>Cerrar Sesión</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        
        <!-- Órdenes de Compra   -->
        <nav class="sidebar" id="sidebar">
            <ul class="menu">

                <!-- Dashboard -->
                <li class="menu-item">
                    <div class="menu-header" onclick="toggleSubmenu(this)">
                        <i class="fas fa-home"></i>
                        <span>Dashboard</span>
                        <div class="menu-tooltip">Dashboard</div>
                    </div>
                </li>

                <!-- Central de Mensajería -->
                <li class="menu-item">
                    <div class="menu-header" onclick="window.location.href='../cliente_mensajeria/cliente_listado_mensajeria.html'">
                        <i class="fas fa-comments"></i>
                        <span>Central de Mensajería</span>
                        <div class="menu-tooltip">Central de Mensajería</div>
                    </div>
                </li>

                <!-- Solicitudes y Cotizaciones -->
                <li class="menu-item active">
                    <div class="menu-header active" onclick="toggleSubmenu(this)">
                        <i class="fas fa-file-alt"></i>
                        <span>Cotización y Compra</span>
                        <i class="fas fa-chevron-right arrow"></i>
                        <div class="menu-tooltip">Cotización y Compra</div>
                    </div>
                    <div class="submenu">
                        <a href="../cliente_solicitud_pedido/cliente_listado_solicitudes.html" class="submenu-item">
                            <span class="full-text">Solicitudes de Pedido</span>
                            <span class="siglas">SP</span>
                            <div class="sigla-tooltip">Solicitudes de Pedido</div>
                        </a>
                        <a href="../cliente_cotizaciones/cliente_listado_cotizaciones.html" class="submenu-item">
                            <span class="full-text">Cotizaciones</span>
                            <span class="siglas">CO</span>
                            <div class="sigla-tooltip">Cotizaciones</div>
                        </a>
                        <a href="cliente_listado_ordenes_compra.html" class="submenu-item active">
                            <span class="full-text">Órdenes de Compra</span>
                            <span class="siglas">OC</span>
                            <div class="sigla-tooltip">Órdenes de Compra</div>
                        </a>
                    </div>
                </li>

                <!-- Control de Entregas -->
                <li class="menu-item">
                    <div class="menu-header" onclick="toggleSubmenu(this)">
                        <i class="fas fa-truck"></i>
                        <span>Control de Entregas</span>
                        <i class="fas fa-chevron-right arrow"></i>
                        <div class="menu-tooltip">Control de Entregas</div>
                    </div>
                    <div class="submenu">
                        <a href="../cliente_control_entrega/cliente_listado_control_entregas.html" class="submenu-item">
                            <span class="full-text">Control Entrega por OC</span>
                            <span class="siglas">CEO</span>
                            <div class="sigla-tooltip">Control Entrega por OC</div>
                        </a>

                        <a href="../cliente_modificaciones/cliente_listado_modificaciones.html" class="submenu-item">
                            <span class="full-text">Modificaciones OC</span>
                            <span class="siglas">MOC</span>
                            <div class="sigla-tooltip">Modificaciones OC</div>
                        </a>

                        <a href="../cliente_control_recepcion/cliente_listado_despachos.html" class="submenu-item">
                            <span class="full-text">Control Recepción</span>
                            <span class="siglas">CRE</span>
                            <div class="sigla-tooltip">Control Recepción</div>
                        </a>

                        <a href="../cliente_incidentes/cliente_listado_incidentes.html" class="submenu-item">
                            <span class="full-text">Incidentes de Entrega</span>
                            <span class="siglas">IEN</span>
                            <div class="sigla-tooltip">Incidentes de Entrega</div>
                        </a>                        
                    </div>
                </li>
                
                <!-- Pagos -->
                <li class="menu-item">
                    <div class="menu-header" onclick="toggleSubmenu(this)">
                        <i class="fas fa-file-invoice-dollar"></i>
                        <span>Pagos</span>
                        <i class="fas fa-chevron-right arrow"></i>
                        <div class="menu-tooltip">Pagos</div>
                    </div>
                    <div class="submenu">
                        <a href="../cliente_pagos/cliente_listado_pagos.html" class="submenu-item">
                            <span class="full-text">Estado de Pagos</span>
                            <span class="siglas">EP</span>
                            <div class="sigla-tooltip">Estado de Pagos</div>
                        </a>                          
                    </div>
                </li>

                <!-- Control Total de Obras -->
                <li class="menu-item">
                    <div class="menu-header" onclick="toggleSubmenu(this)">
                        <i class="fas fa-hard-hat"></i>
                        <span>Control Total de Obras</span>
                        <i class="fas fa-chevron-right arrow"></i>
                        <div class="menu-tooltip">Control Total de Obras</div>
                    </div>
                    <div class="submenu">
                        <a href="../cliente_control_obra/cliente_listado_obras_control.html" class="submenu-item">
                            <span class="full-text">Listado de Obras</span>
                            <span class="siglas">LO</span>
                            <div class="sigla-tooltip">Listado de Obras</div>
                        </a>
                    </div>
                </li>
                
                <!-- Configuración -->
                <li class="menu-item">
                    <div class="menu-header" onclick="toggleSubmenu(this)">
                        <i class="fas fa-cog"></i>
                        <span>Configuración</span>
                        <i class="fas fa-chevron-right arrow"></i>
                        <div class="menu-tooltip">Configuración</div>
                    </div>
                    <div class="submenu">
                        <a href="../cliente_configuracion/cliente_listado_obras.html" class="submenu-item">
                            <span class="full-text">Administración de Obras / Proyectos</span>
                            <span class="siglas">AOP</span>
                            <div class="sigla-tooltip">Administración de Obras / Proyectos</div>
                        </a>
                        <a href="../cliente_configuracion/cliente_listado_usuarios.html" class="submenu-item">
                            <span class="full-text">Administración de Usuarios</span>
                            <span class="siglas">AU</span>
                            <div class="sigla-tooltip">Administración de Usuarios</div>
                        </a>
                    </div>
                </li>

            </ul>
        </nav>
        
        <!-- Toggle Button (fuera del sidebar) -->
        <div class="sidebar-toggle" onclick="toggleSidebar()">
            <i class="fas fa-chevron-left"></i>
        </div>

        <main class="content">
            <div class="breadcrumb">
                <div class="breadcrumb-item"><a href="../cliente_dashboard.html">Inicio</a></div>
                <div class="breadcrumb-item"><a href="#">Facturación y Pagos</a></div>
                <div class="breadcrumb-item"><a href="cliente_listado_ordenes_compra.html">Listado de Órdenes de Compra</a></div>
                <div class="breadcrumb-item active">Nueva Orden de Compra</div>
            </div>

            <div class="page-header">
                <h1 class="page-title">Nueva Orden de Compra</h1>
            </div>

            <!-- Steps Indicator -->
            <div class="steps-container">
                <div class="steps">
                    <div class="step active" id="step1">
                        <div class="step-number">1</div>
                        <div class="step-title">Seleccionar Cotización SSL</div>
                        <div class="step-line"></div>
                    </div>
                    <div class="step" id="step2">
                        <div class="step-number">2</div>
                        <div class="step-title">Información General</div>
                        <div class="step-line"></div>
                    </div>
                    <div class="step" id="step3">
                        <div class="step-number">3</div>
                        <div class="step-title">Productos y Cantidades</div>
                        <div class="step-line"></div>
                    </div>
                    <div class="step" id="step4">
                        <div class="step-number">4</div>
                        <div class="step-title">Confirmación</div>
                    </div>
                </div>
            </div>

            <!-- Step 1: Seleccionar Cotización -->
            <div id="step1-content" class="step-content">
                <div class="form-section">
                    <h2 class="section-title">
                        <i class="fas fa-file-invoice"></i>
                        Seleccionar Cotización
                    </h2>
                    
                    <p style="color: #666; margin-bottom: 20px;">
                        Seleccione la cotización sobre la cual desea generar la Orden de Compra:
                    </p>

                    <div id="cotizaciones-list">
                        <div class="cotizacion-item" onclick="selectCotizacion(this, 'COT-2025-0145')">
                            <div class="cotizacion-header">
                                <span class="cotizacion-number">COT-2025-0145</span>
                                <span class="status-badge" style="background-color: #d4edda; color: #155724;">
                                    <i class="fas fa-circle" style="font-size: 0.6rem;"></i> Vigente
                                </span>
                            </div>
                            <div class="cotizacion-info">
                                <div>
                                    <strong>Obra:</strong> EDIFICIO PACIFIC BLUE
                                </div>
                                <div>
                                    <strong>Fecha:</strong> 19/06/2025
                                </div>
                                <div>
                                    <strong>Ejecutivo:</strong> María González
                                </div>
                                <div>
                                    <strong>Monto:</strong> $2,450,800
                                </div>
                                <div>
                                    <strong>Doc. Referencia Cliente:</strong> SOLPED-2025-001
                                </div>
                                <div>
                                    <strong>Subclasificación:</strong> PEP-001-2025
                                </div>
                            </div>
                        </div>

                        <div class="cotizacion-item" onclick="selectCotizacion(this, 'COT-2025-0144')">
                            <div class="cotizacion-header">
                                <span class="cotizacion-number">COT-2025-0144</span>
                                <span class="status-badge" style="background-color: #d4edda; color: #155724;">
                                    <i class="fas fa-circle" style="font-size: 0.6rem;"></i> Vigente
                                </span>
                            </div>
                            <div class="cotizacion-info">
                                <div>
                                    <strong>Obra:</strong> TORRE ALMAGRO
                                </div>
                                <div>
                                    <strong>Fecha:</strong> 18/06/2025
                                </div>
                                <div>
                                    <strong>Ejecutivo:</strong> Carlos Ruiz
                                </div>
                                <div>
                                    <strong>Monto:</strong> $1,856,200
                                </div>
                                <div>
                                    <strong>Doc. Referencia Cliente:</strong> SOLPED-2025-002
                                </div>
                                <div>
                                    <strong>Subclasificación:</strong> PEP-002-2025
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-navigation">
                        <button class="btn btn-secondary" onclick="window.location.href='cliente_listado_ordenes_compra.html'">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                        <button class="btn btn-primary" onclick="nextStep()" id="btnNext1" disabled>
                            Siguiente <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Step 2: Información General -->
            <div id="step2-content" class="step-content" style="display: none;">
                <div class="form-section">
                    <h2 class="section-title">
                        <i class="fas fa-info-circle"></i>
                        Información General
                    </h2>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Obra / Proyecto</label>
                            <input type="text" class="form-control" id="obra" readonly>
                        </div>

                        <div class="form-group">
                            <label>Dirección de la Obra</label>
                            <input type="text" class="form-control" id="direccionObra" readonly>
                        </div>

                        <div class="form-group">
                            <label>Región de la Obra</label>
                            <input type="text" class="form-control" id="regionObra" readonly>
                        </div>

                        <div class="form-group">
                            <label>N° Cotización Asociada SSL</label>
                            <input type="text" class="form-control" id="cotizacionAsociada" readonly>
                        </div>

                        <div class="form-group">
                            <label>Responsable de la Compra</label>
                            <input type="text" class="form-control" id="responsableCompra" value="Juan Pérez" readonly>
                        </div>

                        <div class="form-group">
                            <label>Solicitud (Doc. Referencia)</label>
                            <input type="text" class="form-control" id="docReferencia" readonly>
                        </div>

                        <div class="form-group">
                            <label>Subclasificación (Doc. Referencia)</label>
                            <input type="text" class="form-control" id="subclasificacion" readonly>
                        </div>

                        <div class="form-group">
                            <label>Número de Orden de Compra <span class="required">*</span></label>
                            <input type="text" class="form-control" id="numeroOC" placeholder="Ej: 4500873120" required>
                            <small class="form-help">Ingrese el número de OC de su sistema</small>
                        </div>

                        <div class="form-group">
                            <label>Fecha de Orden de Compra <span class="required">*</span></label>
                            <input type="date" class="form-control" id="fechaOC" required>
                        </div>


                        <div class="form-group">
                            <label>Código de Verificación</label>
                            <input type="text" class="form-control" id="codigoVerificacion" placeholder="Opcional">
                        </div>

                    </div>

                    <div class="form-group" style="margin-top: 20px;">
                        <label>Observaciones del Cliente</label>
                        <textarea class="form-control" id="observaciones" rows="4" 
                                  placeholder="Ingrese cualquier observación especial para esta orden de compra"></textarea>
                    </div>
                </div>

                <!-- Datos de Facturación -->
                <div class="form-section">
                    <h2 class="section-title">
                        <i class="fas fa-file-invoice"></i>
                        Datos de Facturación
                    </h2>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label>RUT <span class="required">*</span></label>
                            <select class="form-control" id="rutFacturacion" onchange="loadDatosFacturacion()">
                                <option value="">Seleccione RUT...</option>
                                <option value="76.123.456-7">76.123.456-7 - Empresa Demo S.A.</option>
                                <option value="77.234.567-8">77.234.567-8 - Empresa Demo Ltda.</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Razón Social</label>
                            <input type="text" class="form-control" id="razonSocial" readonly>
                        </div>

                        <div class="form-group">
                            <label>Giro</label>
                            <input type="text" class="form-control" id="giro" readonly>
                        </div>

                        <div class="form-group">
                            <label>Dirección</label>
                            <input type="text" class="form-control" id="direccionFacturacion" readonly>
                        </div>

                        <div class="form-group">
                            <label>Ciudad</label>
                            <input type="text" class="form-control" id="ciudadFacturacion" readonly>
                        </div>
                    </div>
                </div>

                <!-- Datos del Proveedor -->
                <div class="form-section">
                    <h2 class="section-title">
                        <i class="fas fa-truck"></i>
                        Datos del Proveedor
                    </h2>
                    
                    <div class="form-grid-2">
                        <div class="info-section">
                            <div class="info-grid">
                                <div class="info-label">RUT:</div>
                                <div class="info-value">76.789.012-3</div>
                                
                                <div class="info-label">Razón Social:</div>
                                <div class="info-value">SSL Soluciones y Servicios Ltda.</div>
                                
                                <div class="info-label">Dirección:</div>
                                <div class="info-value">Av. Libertador Bernardo O'Higgins 1234</div>
                                
                                <div class="info-label">Ciudad:</div>
                                <div class="info-value">Santiago, Región Metropolitana</div>
                            </div>
                        </div>
                        
                        <div class="info-section">
                            <div class="info-grid">
                                <div class="info-label">Contacto:</div>
                                <div class="info-value">María González</div>
                                
                                <div class="info-label">Fono:</div>
                                <div class="info-value">+56 2 2345 6789</div>
                                
                                <div class="info-label">Pago:</div>
                                <div class="info-value">Crédito 30 días</div>
                                
                                <div class="info-label">Moneda:</div>
                                <div class="info-value">CLP - Pesos chilenos</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-navigation">
                    <button class="btn btn-secondary" onclick="previousStep()">
                        <i class="fas fa-chevron-left"></i> Anterior
                    </button>
                    <button class="btn btn-primary" onclick="nextStep()">
                        Siguiente <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>

            <!-- Step 3: Productos y Cantidades -->
            <div id="step3-content" class="step-content" style="display: none;">
                <div class="form-section">
                    <h2 class="section-title">
                        <i class="fas fa-boxes"></i>
                        Productos y Cantidades
                    </h2>
                    
                    <p style="color: #666; margin-bottom: 20px;">
                        Revise y ajuste las cantidades y fechas de entrega según sus necesidades:
                    </p>

                    <table class="products-table">
                        <thead>
                            <tr>
                                <th>Código Cliente</th>
                                <th>Descripción Cliente</th>
                                <th>Código SSL</th>
                                <th>Descripción SSL</th>
                                <th>U.M.</th>
                                <th>Fecha Entrega</th>
                                <th>Cant. Cotizada</th>
                                <th>Cant. OC</th>
                                <th>Precio Unit.</th>
                                <th>Valor Total</th>
                            </tr>
                        </thead>
                        <tbody id="productosOC">
                            <!-- Se llenará dinámicamente según la cotización seleccionada -->
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="9" style="text-align: right;">Subtotal:</td>
                                <td style="text-align: right;" id="subtotal">$0</td>
                            </tr>
                            <tr>
                                <td colspan="9" style="text-align: right;">IVA (19%):</td>
                                <td style="text-align: right;" id="iva">$0</td>
                            </tr>
                            <tr style="background-color: #e8eafd;">
                                <td colspan="9" style="text-align: right; font-size: 1.1rem;">Total:</td>
                                <td style="text-align: right; font-size: 1.1rem; color: var(--primary-color);" id="total">$0</td>
                            </tr>
                        </tfoot>
                    </table>

                    <div class="form-navigation">
                        <button class="btn btn-secondary" onclick="previousStep()">
                            <i class="fas fa-chevron-left"></i> Anterior
                        </button>
                        <button class="btn btn-primary" onclick="nextStep()">
                            Siguiente <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Step 4: Confirmación -->
            <div id="step4-content" class="step-content" style="display: none;">
                <div class="form-section">
                    <h2 class="section-title">
                        <i class="fas fa-check-circle"></i>
                        Confirmación y Documentos
                    </h2>
                    
                    <div style="background-color: #d4edda; border-left: 4px solid var(--success-color); border-radius: 8px; padding: 15px 20px; margin-bottom: 25px;">
                        <p style="margin: 0; color: #155724;">
                            <i class="fas fa-check-circle" style="margin-right: 8px;"></i>
                            Por favor revise toda la información antes de confirmar la Orden de Compra.
                        </p>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label>N° Orden de Compra:</label>
                            <div class="form-value" id="resumenOC">-</div>
                        </div>
                        <div class="form-group">
                            <label>Fecha de Orden de Compra</label>
                            <div class="form-value" id="resumenFechaOC">-</div>
                        </div>        

                        <div class="form-group">
                            <label>Código de Verificación</label>
                            <div class="form-value" id="resumenCodigoVerificacion">-</div>
                        </div>        
                        <div class="form-group">
                            <label>N° Cotización Asociada SSL:</label>
                            <div class="form-value" id="resumenCotizacion">-</div>
                        </div>
                        <div class="form-group">
                            <label>Obra / Proyecto:</label>
                            <div class="form-value" id="resumenObra">-</div>
                        </div>
                        <div class="form-group">
                            <label>Dirección de la Obra/Proyecto:</label>
                            <div class="form-value" id="resumenDireccionObra">-</div>
                        </div>
                        <div class="form-group">
                            <label>Región de la Obra/Proyecto:</label>
                            <div class="form-value" id="resumenRegionObra">-</div>
                        </div>

                        <div class="form-group">
                            <label>Responsable de la Compra:</label>
                            <div class="form-value" id="resumenResponsableCompra">-</div>
                        </div>
                        <div class="form-group">
                            <label>Solicitud (Doc. Referencia)</label>
                            <div class="form-value" id="resumenDocReferencia">-</div>
                        </div>
                        <div class="form-group">
                            <label>Subclasificación (Doc. Referencia)</label>
                            <div class="form-value" id="resumenSubclasificacion">-</div>
                        </div>
                        <!--div class="form-group">
                            <label>Observaciones del Cliente</label>
                            <div class="form-value" id="resumenObservaciones">-</div>
                        </div-->                                           
                        <div class="form-group">
                            <label>Monto Total:</label>
                            <div class="form-value" style="font-weight: 600; color: var(--success-color);" id="resumenTotal">$0</div>
                        </div>
                    </div>

                    <!-- Datos de Facturación Resumen -->
                    <h3 style="margin-top: 30px; margin-bottom: 15px; color: var(--primary-color); font-size: 1.1rem;">
                        <i class="fas fa-file-invoice" style="color: var(--secondary-color); margin-right: 8px;"></i>
                        Observaciones del Cliente
                    </h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Observaciones del Cliente</label>
                            <div class="form-value" id="resumenObservaciones">-</div>
                        </div>   
                    </div>
                    <!-- Datos de Facturación Resumen -->
                    <h3 style="margin-top: 30px; margin-bottom: 15px; color: var(--primary-color); font-size: 1.1rem;">
                        <i class="fas fa-file-invoice" style="color: var(--secondary-color); margin-right: 8px;"></i>
                        Datos de Facturación
                    </h3>
                    <div class="info-section">
                        <div class="info-grid">
                            <div class="info-label">RUT:</div>
                            <div class="info-value" id="resumenRutFacturacion">-</div>
                            
                            <div class="info-label">Razón Social:</div>
                            <div class="info-value" id="resumenRazonSocial">-</div>
                            
                            <div class="info-label">Giro:</div>
                            <div class="info-value" id="resumenGiro">-</div>
                            
                            <div class="info-label">Dirección:</div>
                            <div class="info-value" id="resumenDireccionFacturacion">-</div>
                            
                            <div class="info-label">Ciudad:</div>
                            <div class="info-value" id="resumenCiudadFacturacion">-</div>
                        </div>
                    </div>

                    <!-- Datos del Proveedor Resumen -->
                    <h3 style="margin-top: 30px; margin-bottom: 15px; color: var(--primary-color); font-size: 1.1rem;">
                        <i class="fas fa-truck" style="color: var(--secondary-color); margin-right: 8px;"></i>
                        Datos del Proveedor
                    </h3>
                    <div class="info-section">
                        <div class="form-grid-2">
                            <div>
                                <div class="info-grid">
                                    <div class="info-label">RUT:</div>
                                    <div class="info-value">76.789.012-3</div>
                                    
                                    <div class="info-label">Razón Social:</div>
                                    <div class="info-value">SSL Soluciones y Servicios Ltda.</div>
                                    
                                    <div class="info-label">Dirección:</div>
                                    <div class="info-value">Av. Libertador Bernardo O'Higgins 1234</div>
                                    
                                    <div class="info-label">Ciudad:</div>
                                    <div class="info-value">Santiago, Región Metropolitana</div>
                                </div>
                            </div>
                            
                            <div>
                                <div class="info-grid">
                                    <div class="info-label">Contacto:</div>
                                    <div class="info-value">María González</div>
                                    
                                    <div class="info-label">Fono:</div>
                                    <div class="info-value">+56 2 2345 6789</div>
                                    
                                    <div class="info-label">Pago:</div>
                                    <div class="info-value">Crédito 30 días</div>
                                    
                                    <div class="info-label">Moneda:</div>
                                    <div class="info-value">CLP - Pesos chilenos</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <h3 style="margin-top: 30px; margin-bottom: 15px; color: var(--primary-color); font-size: 1.1rem;">
                        <i class="fas fa-paperclip" style="color: var(--secondary-color); margin-right: 8px;"></i>
                        Adjuntar Orden de Compra Original
                    </h3>

                    <div class="file-upload" id="fileUploadArea">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p>Arrastre y suelte su archivo aquí o haga clic para seleccionar</p>
                        <button type="button" class="file-upload-button" onclick="document.getElementById('fileInput').click()">
                            Seleccionar Archivo
                        </button>
                        <input type="file" id="fileInput" style="display: none;" accept=".pdf,.doc,.docx,.xls,.xlsx" onchange="handleFileSelect(this)">
                    </div>

                    <div class="uploaded-files" id="uploadedFiles" style="display: none;">
                        <!-- Se mostrará el archivo subido -->
                    </div>

                    <div class="form-navigation">
                        <button class="btn btn-secondary" onclick="previousStep()">
                            <i class="fas fa-chevron-left"></i> Anterior
                        </button>
                        <button class="btn btn-success" onclick="confirmarOC()">
                            <i class="fas fa-check"></i> Confirmar Orden de Compra
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Variables globales
        let userData = null;
        let currentStep = 1;
        let selectedCotizacion = null;
        let ocData = {
            cotizacion: null,
            obra: null,
            direccionObra: null,
            regionObra: null,
            numeroOC: null,
            fechaOC: null,
            codigoVerificacion: null,
            observaciones: null,
            productos: [],
            archivo: null,
            docReferencia: null,
            subclasificacion: null,
            responsableCompra: null,            
            datosFacturacion: {
                rut: null,
                razonSocial: null,
                giro: null,
                direccion: null,
                ciudad: null
            }
        };

        // Datos simulados para las obras
        const obrasData = {
            'COT-2025-0145': {
                obra: 'EDIFICIO PACIFIC BLUE',
                direccion: 'Av. Providencia 2345, Providencia',
                region: 'Región Metropolitana',
                docReferencia: 'SOLPED-2025-001',
                subclasificacion: 'PEP-001-2025',
                responsableCompra: 'Juan Pérez'                
            },
            'COT-2025-0144': {
                obra: 'TORRE ALMAGRO',
                direccion: 'Calle Almagro 567, Ñuñoa',
                region: 'Región Metropolitana',
                docReferencia: 'SOLPED-2025-002',
                subclasificacion: 'PEP-002-2025',
                responsableCompra: 'María Fernández'                
            }
        };

        // Datos simulados de facturación
        const datosFacturacionDB = {
            '76.123.456-7': {
                razonSocial: 'Empresa Demo S.A.',
                giro: 'Construcción de Edificios',
                direccion: 'Av. Apoquindo 1234, Las Condes',
                ciudad: 'Santiago'
            },
            '77.234.567-8': {
                razonSocial: 'Empresa Demo Ltda.',
                giro: 'Servicios de Ingeniería',
                direccion: 'Los Leones 456, Providencia',
                ciudad: 'Santiago'
            }
        };

        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            loadUserData();
            updateDate();
            setToday();
            loadSidebarState();
            
            // Update date every minute
            setInterval(updateDate, 60000);
        });

        // Set today's date
        function setToday() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('fechaOC').value = today;
        }

        // Toggle sidebar collapse
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const toggleButton = document.querySelector('.sidebar-toggle');
            const isCollapsed = sidebar.classList.contains('collapsed');
            
            if (isCollapsed) {
                sidebar.classList.remove('collapsed');
                localStorage.setItem('sidebarCollapsed', 'false');
            } else {
                sidebar.classList.add('collapsed');
                localStorage.setItem('sidebarCollapsed', 'true');
            }
            
            // Update button icon rotation
            const icon = toggleButton.querySelector('i');
            if (sidebar.classList.contains('collapsed')) {
                icon.style.transform = 'rotate(180deg)';
            } else {
                icon.style.transform = 'rotate(0deg)';
            }
        }

        // Load sidebar state from localStorage
        function loadSidebarState() {
            const isCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
            const sidebar = document.getElementById('sidebar');
            const toggleButton = document.querySelector('.sidebar-toggle');
            const icon = toggleButton.querySelector('i');
            
            if (isCollapsed) {
                sidebar.classList.add('collapsed');
                icon.style.transform = 'rotate(180deg)';
            }
        }

        // Toggle mobile menu
        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('active');
        }

        // Toggle submenu
        function toggleSubmenu(header) {
            const menuItem = header.parentElement;
            const sidebar = document.getElementById('sidebar');
            const wasActive = menuItem.classList.contains('active');
            
            // If sidebar is collapsed and clicking on item with submenu, don't expand sidebar
            // Just toggle the submenu
            
            // Close all submenus
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Remove active from all headers
            document.querySelectorAll('.menu-header').forEach(h => {
                h.classList.remove('active');
            });
            
            // If it wasn't active, open it
            if (!wasActive && header.nextElementSibling) {
                menuItem.classList.add('active');
            }
            
            // Always keep the clicked header active if it's a main item
            if (!header.querySelector('.arrow')) {
                header.classList.add('active');
            }
        }

        // User menu dropdown
        const userMenu = document.getElementById('userMenu');
        let isUserMenuOpen = false;

        userMenu.addEventListener('click', function(e) {
            e.stopPropagation();
            isUserMenuOpen = !isUserMenuOpen;
            this.classList.toggle('active');
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!userMenu.contains(e.target) && isUserMenuOpen) {
                userMenu.classList.remove('active');
                isUserMenuOpen = false;
            }
        });

        // Update date
        function updateDate() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            const formattedDate = now.toLocaleDateString('es-CL', options);
            const capitalizedDate = formattedDate.charAt(0).toUpperCase() + formattedDate.slice(1);
            document.getElementById('currentDate').textContent = capitalizedDate;
        }

        // Load user data
        function loadUserData() {
            const userDataStr = sessionStorage.getItem('userData');
            if (userDataStr) {
                try {
                    userData = JSON.parse(userDataStr);
                    const userName = userData.name || 'Cliente';
                    const userEmail = userData.email || 'cliente@demo.com';
                    
                    // Update UI
                    document.getElementById('userName').textContent = userName;
                    document.getElementById('dropdownUserName').textContent = userName;
                    document.getElementById('dropdownUserEmail').textContent = userEmail;
                    
                    // Update initials
                    const initial = userName.charAt(0).toUpperCase();
                    document.getElementById('userInitial').textContent = initial;
                    document.getElementById('dropdownUserInitial').textContent = initial;
                } catch (e) {
                    console.error('Error parsing user data:', e);
                }
            }
        }

        // Select cotización
        function selectCotizacion(element, cotizacionId) {
            // Remove previous selection
            document.querySelectorAll('.cotizacion-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // Add selection to clicked item
            element.classList.add('selected');
            selectedCotizacion = cotizacionId;
            
            // Enable next button
            document.getElementById('btnNext1').disabled = false;
            
            // Store cotización data
            ocData.cotizacion = cotizacionId;
            const obraData = obrasData[cotizacionId];
            ocData.obra = obraData.obra;
            ocData.direccionObra = obraData.direccion;
            ocData.regionObra = obraData.region;
            ocData.docReferencia = obraData.docReferencia;
            ocData.subclasificacion = obraData.subclasificacion;
            ocData.responsableCompra = obraData.responsableCompra;            
        }

        // Load datos facturación
        function loadDatosFacturacion() {
            const rutSelect = document.getElementById('rutFacturacion');
            const selectedRut = rutSelect.value;
            
            if (selectedRut && datosFacturacionDB[selectedRut]) {
                const datos = datosFacturacionDB[selectedRut];
                document.getElementById('razonSocial').value = datos.razonSocial;
                document.getElementById('giro').value = datos.giro;
                document.getElementById('direccionFacturacion').value = datos.direccion;
                document.getElementById('ciudadFacturacion').value = datos.ciudad;
                
                // Store in ocData
                ocData.datosFacturacion = {
                    rut: selectedRut,
                    razonSocial: datos.razonSocial,
                    giro: datos.giro,
                    direccion: datos.direccion,
                    ciudad: datos.ciudad
                };
            } else {
                document.getElementById('razonSocial').value = '';
                document.getElementById('giro').value = '';
                document.getElementById('direccionFacturacion').value = '';
                document.getElementById('ciudadFacturacion').value = '';
            }
        }

        // Next step
        function nextStep() {
            if (currentStep === 1 && !selectedCotizacion) {
                alert('Por favor seleccione una cotización');
                return;
            }
            
            if (currentStep === 2) {
                // Validate step 2
                const numeroOC = document.getElementById('numeroOC').value;
                const fechaOC = document.getElementById('fechaOC').value;
                const rutFacturacion = document.getElementById('rutFacturacion').value;
                
                if (!numeroOC || !fechaOC || !rutFacturacion) {
                    alert('Por favor complete todos los campos obligatorios');
                    return;
                }
                
                // Store data
                ocData.numeroOC = numeroOC;
                ocData.fechaOC = fechaOC;
                ocData.codigoVerificacion = document.getElementById('codigoVerificacion').value;
                ocData.observaciones = document.getElementById('observaciones').value;
                ocData.responsableCompra = document.getElementById('responsableCompra').value;
                
                // Load products for step 3
                loadProductos();
            }
            
            if (currentStep === 3) {
                // Update summary for step 4
                updateResumen();
            }
            
            // Hide current step
            document.getElementById(`step${currentStep}-content`).style.display = 'none';
            document.getElementById(`step${currentStep}`).classList.remove('active');
            document.getElementById(`step${currentStep}`).classList.add('completed');
            
            // Show next step
            currentStep++;
            document.getElementById(`step${currentStep}-content`).style.display = 'block';
            document.getElementById(`step${currentStep}`).classList.add('active');
            
            // Update data in step 2
            if (currentStep === 2) {
                document.getElementById('obra').value = ocData.obra;
                document.getElementById('cotizacionAsociada').value = ocData.cotizacion;
                document.getElementById('direccionObra').value = ocData.direccionObra;
                document.getElementById('regionObra').value = ocData.regionObra;
                document.getElementById('docReferencia').value = ocData.docReferencia;
                document.getElementById('subclasificacion').value = ocData.subclasificacion;
                document.getElementById('responsableCompra').value = ocData.responsableCompra;                
            }
        }

        // Previous step
        function previousStep() {
            // Hide current step
            document.getElementById(`step${currentStep}-content`).style.display = 'none';
            document.getElementById(`step${currentStep}`).classList.remove('active');
            
            // Show previous step
            currentStep--;
            document.getElementById(`step${currentStep}-content`).style.display = 'block';
            document.getElementById(`step${currentStep}`).classList.add('active');
            document.getElementById(`step${currentStep}`).classList.remove('completed');
        }

        // Load productos
        function loadProductos() {
            const tbody = document.getElementById('productosOC');
            tbody.innerHTML = '';
            
            // Simulate loading products from selected cotización
            const productos = [
                {
                    codigoCliente: 'CLI-33087361',
                    descripcionCliente: 'CABLE ELÉCTRICO 3X10 CLIENTE',
                    codigoSSL: 'EL-1245',
                    descripcionSSL: 'CABLE ELÉCTRICO NYY 3X10MM2 0.6/1KV',
                    um: 'MT',
                    fechaEntrega: '27/05/2025',
                    cantidadCotizada: 100,
                    precio: 4500
                },
                {
                    codigoCliente: 'CLI-33087362',
                    descripcionCliente: 'TUBO CONDUIT 25MM CLIENTE',
                    codigoSSL: 'EL-0876',
                    descripcionSSL: 'TUBO CONDUIT PVC 25MM',
                    um: 'UN',
                    fechaEntrega: '27/05/2025',
                    cantidadCotizada: 50,
                    precio: 2800
                }
            ];
            
            productos.forEach((producto, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${producto.codigoCliente}</td>
                    <td>${producto.descripcionCliente}</td>
                    <td>${producto.codigoSSL}</td>
                    <td>${producto.descripcionSSL}</td>
                    <td>${producto.um}</td>
                    <td><input type="date" value="${new Date().toISOString().split('T')[0]}" onchange="updateProducto(${index}, 'fecha', this.value)"></td>
                    <td style="text-align: right;">${producto.cantidadCotizada}</td>
                    <td><input type="number" value="${producto.cantidadCotizada}" min="1" style="width: 80px; text-align: right;" onchange="updateProducto(${index}, 'cantidad', this.value)"></td>
                    <td style="text-align: right;">${producto.precio.toLocaleString('es-CL')}</td>
                    <td style="text-align: right; font-weight: 600;" id="total-${index}">${(producto.cantidadCotizada * producto.precio).toLocaleString('es-CL')}</td>
                `;
                tbody.appendChild(row);
            });
            
            ocData.productos = productos;
            updateTotales();
        }

        // Update producto
        function updateProducto(index, field, value) {
            if (field === 'cantidad') {
                ocData.productos[index].cantidadOC = parseInt(value) || 0;
                const total = ocData.productos[index].cantidadOC * ocData.productos[index].precio;
                document.getElementById(`total-${index}`).textContent = `${total.toLocaleString('es-CL')}`;
            } else if (field === 'fecha') {
                ocData.productos[index].fechaEntrega = value;
            }
            updateTotales();
        }

        // Update totales
        function updateTotales() {
            let subtotal = 0;
            ocData.productos.forEach((producto, index) => {
                const cantidad = producto.cantidadOC || producto.cantidadCotizada;
                subtotal += cantidad * producto.precio;
            });
            
            const iva = subtotal * 0.19;
            const total = subtotal + iva;
            
            document.getElementById('subtotal').textContent = `${subtotal.toLocaleString('es-CL')}`;
            document.getElementById('iva').textContent = `${Math.round(iva).toLocaleString('es-CL')}`;
            document.getElementById('total').textContent = `${Math.round(total).toLocaleString('es-CL')}`;
        }

        // Update resumen
        function updateResumen() {
            document.getElementById('resumenOC').textContent = ocData.numeroOC;
            document.getElementById('resumenFechaOC').textContent = formatDate(ocData.fechaOC);
            document.getElementById('resumenCodigoVerificacion').textContent = ocData.codigoVerificacion || 'N/A';            
            document.getElementById('resumenCotizacion').textContent = ocData.cotizacion;
            document.getElementById('resumenObra').textContent = ocData.obra;
            document.getElementById('resumenDireccionObra').textContent = ocData.direccionObra;
            document.getElementById('resumenRegionObra').textContent = ocData.regionObra;
            document.getElementById('resumenResponsableCompra').textContent = ocData.responsableCompra;
            document.getElementById('resumenDocReferencia').textContent = ocData.docReferencia;
            document.getElementById('resumenSubclasificacion').textContent = ocData.subclasificacion;
            document.getElementById('resumenObservaciones').textContent = ocData.observaciones || 'Sin observaciones';            
            
            // Datos de facturación
            document.getElementById('resumenRutFacturacion').textContent = ocData.datosFacturacion.rut;
            document.getElementById('resumenRazonSocial').textContent = ocData.datosFacturacion.razonSocial;
            document.getElementById('resumenGiro').textContent = ocData.datosFacturacion.giro;
            document.getElementById('resumenDireccionFacturacion').textContent = ocData.datosFacturacion.direccion;
            document.getElementById('resumenCiudadFacturacion').textContent = ocData.datosFacturacion.ciudad;
            
            // Calculate total
            let subtotal = 0;
            ocData.productos.forEach(producto => {
                const cantidad = producto.cantidadOC || producto.cantidadCotizada;
                subtotal += cantidad * producto.precio;
            });
            const total = subtotal * 1.19;
            document.getElementById('resumenTotal').textContent = `${Math.round(total).toLocaleString('es-CL')}`;
        }

        // Format date helper function
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('es-CL', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        // Handle file select
        function handleFileSelect(input) {
            const file = input.files[0];
            if (file) {
                ocData.archivo = file;
                
                // Show uploaded file
                const uploadedFiles = document.getElementById('uploadedFiles');
                uploadedFiles.innerHTML = `
                    <div class="uploaded-file">
                        <div class="uploaded-file-info">
                            <i class="fas fa-file-pdf"></i>
                            <span>${file.name}</span>
                            <span style="color: #999; font-size: 0.85rem;">(${(file.size / 1024).toFixed(2)} KB)</span>
                        </div>
                        <span class="remove-file" onclick="removeFile()">
                            <i class="fas fa-times"></i>
                        </span>
                    </div>
                `;
                uploadedFiles.style.display = 'block';
            }
        }

        // Remove file
        function removeFile() {
            ocData.archivo = null;
            document.getElementById('fileInput').value = '';
            document.getElementById('uploadedFiles').style.display = 'none';
        }

        // Confirmar OC
        function confirmarOC() {
            if (!ocData.archivo) {
                if (!confirm('No ha adjuntado la Orden de Compra original. ¿Desea continuar de todas formas?')) {
                    return;
                }
            }
            
            // Show loading
            const btn = event.target;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';
            
            setTimeout(() => {
                alert(`✅ Orden de Compra creada exitosamente\n\n` +
                      `N° OC Cliente: ${ocData.numeroOC}\n` +
                      `N° OC SSL: OC-SSL-2025-0146\n\n` +
                      `La orden ha sido enviada a SSL para su confirmación.\n` +
                      `Recibirá una notificación cuando sea procesada.`);
                
                window.location.href = 'cliente_listado_ordenes_compra.html';
            }, 2000);
        }

        // Profile function
        function goToProfile(e) {
            e.preventDefault();
            alert('Navegando al perfil de usuario...\nEsta funcionalidad estará disponible próximamente.');
            userMenu.classList.remove('active');
            isUserMenuOpen = false;
        }

        // Settings function
        function goToSettings(e) {
            e.preventDefault();
            loadContent('configuracion');
            userMenu.classList.remove('active');
            isUserMenuOpen = false;
        }

        // Logout function
        function logout(e) {
            e.preventDefault();
            if (confirm('¿Está seguro que desea cerrar sesión?')) {
                sessionStorage.clear();
                window.location.href = '../../index.html';
            }
        }

        // Show notifications
        function showNotifications() {
            alert('Panel de notificaciones\n\nEsta funcionalidad estará disponible próximamente.');
        }

        // Load content (simulated)
        function loadContent(section) {
            alert(`Navegando a ${section}...\nEsta funcionalidad estará disponible próximamente.`);
        }

        // Drag and drop functionality
        const fileUploadArea = document.getElementById('fileUploadArea');

        fileUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileUploadArea.classList.add('dragover');
        });

        fileUploadArea.addEventListener('dragleave', () => {
            fileUploadArea.classList.remove('dragover');
        });

        fileUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            fileUploadArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                document.getElementById('fileInput').files = files;
                handleFileSelect(document.getElementById('fileInput'));
            }
        });
    </script>
</body>
</html>